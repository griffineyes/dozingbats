<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Where's the Bat? Cartoon Night Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Comic Neue', cursive;
            overflow: hidden;
        }
        
        .game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        
        .night-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #312e81, #581c87, #312e81);
            z-index: 1;
        }
        
        .star {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #fef08a;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        .big-star {
            position: absolute;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            animation: ping 4s infinite;
        }
        
        .firefly {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #fde047;
            border-radius: 50%;
            opacity: 0.7;
            animation: bounce 3s infinite;
        }
        
        .start-screen, .game-screen, .result-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .game-screen {
            cursor: none;
            z-index: 3;
        }
        
        .start-box, .result-box {
            background: rgba(0, 0, 0, 0.7);
            padding: 2rem;
            border-radius: 1.5rem;
            border: 4px solid #fde047;
            text-align: center;
        }
        
        .title {
            font-size: 3rem;
            font-weight: bold;
            color: #fde047;
            margin-bottom: 1rem;
        }
        
        .subtitle {
            font-size: 1.25rem;
            color: #bfdbfe;
            margin-bottom: 2rem;
        }
        
        .button {
            padding: 1rem 2.5rem;
            background: linear-gradient(to right, #7c3aed, #2563eb);
            color: white;
            border: 2px solid #fde047;
            border-radius: 2rem;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            font-family: 'Comic Neue', cursive;
        }
        
        .button:hover {
            transform: scale(1.05);
        }
        
        .result-button {
            background: linear-gradient(to right, #10b981, #2563eb);
        }
        
        .flashlight-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 4;
        }
        
        .illuminated-scene {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: none;
            /* Hide everything initially until mask is applied */
            -webkit-mask-image: radial-gradient(circle 0px at 50% 50%, white 0%, white 100%, transparent 100%);
            mask-image: radial-gradient(circle 0px at 50% 50%, white 0%, white 100%, transparent 100%);
        }
        
        .flashlight-indicator {
            position: absolute;
            width: 128px;
            height: 128px;
            border: 4px solid #facc15;
            border-radius: 50%;
            pointer-events: none;
            background: radial-gradient(circle, rgba(255,255,0,0.1) 0%, transparent 70%);
            box-shadow: 0 0 30px rgba(255, 255, 0, 0.4);
            z-index: 5;
        }
        
        .moon {
            position: absolute;
            top: 2rem;
            right: 2rem;
            width: 480px;
            height: 480px;
            z-index: 2;
        }
        
        .bat-container {
            position: absolute;
            transform: translate(-50%, -50%);
            transition: all 0.5s ease-in-out;
            z-index: 6;
        }
        
        .bat-revealed {
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.5));
        }
        
        .result-text {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fde047;
            margin-bottom: 1rem;
        }
        
        .moon-phase-text {
            font-size: 1.125rem;
            color: #bfdbfe;
            margin-bottom: 1rem;
        }
        
        .hidden {
            display: none;
        }
        
        .zoom-in {
            animation: zoomIn 0.8s ease-out;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        @keyframes ping {
            0% { transform: scale(1); opacity: 1; }
            75%, 100% { transform: scale(1.5); opacity: 0; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes zoomIn {
            from {
                transform: scale(0.1);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="game-container" id="gameContainer">
        <!-- Night Background -->
        <div class="night-background" id="nightBackground">
            <!-- Static castle in night background -->
            <svg class="night-castle" style="position: absolute; bottom: 0; left: 35%; width: 400px; height: 240px; z-index: 2;" viewBox="0 0 400 240">
                <!-- Castle base -->
                <rect x="40" y="120" width="240" height="120" fill="#2F2F2F" stroke="#1a1a1a" stroke-width="2" />
                
                <!-- Left tower -->
                <rect x="0" y="80" width="80" height="160" fill="#2F2F2F" stroke="#1a1a1a" stroke-width="2" />
                <!-- Left tower battlements -->
                <rect x="0" y="80" width="16" height="20" fill="#2F2F2F" />
                <rect x="21" y="80" width="16" height="20" fill="#2F2F2F" />
                <rect x="42" y="80" width="16" height="20" fill="#2F2F2F" />
                <rect x="63" y="80" width="17" height="20" fill="#2F2F2F" />
                
                <!-- Right tower -->
                <rect x="280" y="90" width="70" height="150" fill="#2F2F2F" stroke="#1a1a1a" stroke-width="2" />
                <!-- Right tower battlements -->
                <rect x="280" y="90" width="14" height="18" fill="#2F2F2F" />
                <rect x="299" y="90" width="14" height="18" fill="#2F2F2F" />
                <rect x="318" y="90" width="14" height="18" fill="#2F2F2F" />
                <rect x="337" y="90" width="13" height="18" fill="#2F2F2F" />
                
                <!-- Center tower (tallest) -->
                <rect x="170" y="60" width="60" height="180" fill="#2F2F2F" stroke="#1a1a1a" stroke-width="2" />
                <!-- Center tower battlements -->
                <rect x="170" y="60" width="12" height="16" fill="#2F2F2F" />
                <rect x="186" y="60" width="12" height="16" fill="#2F2F2F" />
                <rect x="202" y="60" width="12" height="16" fill="#2F2F2F" />
                <rect x="218" y="60" width="12" height="16" fill="#2F2F2F" />
                
                <!-- Castle roofs (pointed Gothic style) -->
                <polygon points="0,80 40,30 80,80" fill="#4a4a4a" stroke="#1a1a1a" stroke-width="2" />
                <polygon points="170,60 200,20 230,60" fill="#4a4a4a" stroke="#1a1a1a" stroke-width="2" />
                <polygon points="280,90 315,50 350,90" fill="#4a4a4a" stroke="#1a1a1a" stroke-width="2" />
                
                <!-- Main battlements on base -->
                <rect x="40" y="120" width="20" height="16" fill="#2F2F2F" />
                <rect x="70" y="120" width="20" height="16" fill="#2F2F2F" />
                <rect x="100" y="120" width="20" height="16" fill="#2F2F2F" />
                <rect x="130" y="120" width="20" height="16" fill="#2F2F2F" />
                <rect x="230" y="120" width="20" height="16" fill="#2F2F2F" />
                <rect x="260" y="120" width="20" height="16" fill="#2F2F2F" />
                
                <!-- Gothic arched main gate -->
                <path d="M 140 180 Q 140 160 160 160 L 180 160 Q 200 160 200 180 L 200 240 L 140 240 Z" fill="#000" stroke="#1a1a1a" stroke-width="1" />
                <!-- Gate details -->
                <rect x="165" y="200" width="10" height="40" fill="#654321" />
                <circle cx="170" cy="210" r="2" fill="#8b7355" />
                
                <!-- Gothic arched windows -->
                <!-- Left tower windows -->
                <path d="M 25 130 Q 25 120 35 120 Q 45 120 45 130 L 45 150 L 25 150 Z" fill="#ffb347" opacity="0.3" />
                <path d="M 25 170 Q 25 160 35 160 Q 45 160 45 170 L 45 185 L 25 185 Z" fill="#ffb347" opacity="0.25" />
                
                <!-- Center tower windows -->
                <path d="M 185 100 Q 185 90 195 90 Q 205 90 205 100 L 205 115 L 185 115 Z" fill="#ffb347" opacity="0.35" />
                <path d="M 185 140 Q 185 130 195 130 Q 205 130 205 140 L 205 155 L 185 155 Z" fill="#ffb347" opacity="0.3" />
                
                <!-- Right tower windows -->
                <path d="M 300 130 Q 300 120 310 120 Q 320 120 320 130 L 320 145 L 300 145 Z" fill="#ffb347" opacity="0.28" />
                <path d="M 300 170 Q 300 160 310 160 Q 320 160 320 170 L 320 185 L 300 185 Z" fill="#ffb347" opacity="0.32" />
                
                <!-- Gothic spires and details -->
                <!-- Left spire cross -->
                <rect x="38" y="25" width="4" height="15" fill="#4a4a4a" />
                <rect x="32" y="29" width="16" height="4" fill="#4a4a4a" />
                
                <!-- Center spire cross -->
                <rect x="198" y="15" width="4" height="15" fill="#4a4a4a" />
                <rect x="192" y="19" width="16" height="4" fill="#4a4a4a" />
                
                <!-- Right spire cross -->
                <rect x="313" y="45" width="4" height="15" fill="#4a4a4a" />
                <rect x="307" y="49" width="16" height="4" fill="#4a4a4a" />
                
                <!-- Gothic flags -->
                <rect x="36" y="20" width="2" height="30" fill="#654321" />
                <polygon points="38,20 38,35 50,27.5" fill="#8b0000" opacity="0.7" />
                <rect x="196" y="10" width="2" height="35" fill="#654321" />
                <polygon points="198,10 198,28 212,19" fill="#000080" opacity="0.7" />
                <rect x="311" y="40" width="2" height="25" fill="#654321" />
                <polygon points="313,40 313,52 325,46" fill="#4b0082" opacity="0.7" />
                
                <!-- Stone texture lines -->
                <line x1="40" y1="160" x2="280" y2="160" stroke="#1a1a1a" stroke-width="1" opacity="0.5" />
                <line x1="40" y1="200" x2="280" y2="200" stroke="#1a1a1a" stroke-width="1" opacity="0.5" />
                <line x1="0" y1="140" x2="80" y2="140" stroke="#1a1a1a" stroke-width="1" opacity="0.5" />
                <line x1="280" y1="150" x2="350" y2="150" stroke="#1a1a1a" stroke-width="1" opacity="0.5" />
                <line x1="170" y1="120" x2="230" y2="120" stroke="#1a1a1a" stroke-width="1" opacity="0.5" />
            </svg>
        </div>
        
        <!-- Start Screen -->
        <div class="start-screen" id="startScreen">
            <div class="start-box">
                <h1 class="title">🦇 Where's the Bat? 🦇</h1>
                <p class="subtitle">Find the hidden bat in the moonlit night!</p>
                <button class="button" onclick="startGame()">🔦 Start Hunt</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div class="game-screen hidden" id="gameScreen">
            <div class="moon" id="moon"></div>
            <div class="flashlight-area" id="flashlightArea">
                <div class="illuminated-scene" id="illuminatedScene">
                    <!-- Trees will be added here -->
                    <svg class="trees" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 16rem;" viewBox="0 0 1000 200" preserveAspectRatio="none">
                        <!-- Tree 1 -->
                        <rect x="50" y="120" width="20" height="80" fill="#2F2F2F" />
                        <ellipse cx="60" cy="110" rx="40" ry="35" fill="#1a472a" />
                        <ellipse cx="60" cy="95" rx="35" ry="30" fill="#1e5d32" />
                        <ellipse cx="60" cy="85" rx="25" ry="25" fill="#228b3d" />
                        
                        <!-- Tree 2 -->
                        <rect x="200" y="100" width="25" height="100" fill="#2F2F2F" />
                        <ellipse cx="212" cy="90" rx="50" ry="40" fill="#1a472a" />
                        <ellipse cx="212" cy="70" rx="40" ry="35" fill="#1e5d32" />
                        <ellipse cx="212" cy="55" rx="30" ry="30" fill="#228b3d" />
                        
                        <!-- Small Castle (Illuminated version) -->
                        <!-- Castle base -->
                        <rect x="400" y="100" width="240" height="100" fill="#4a4a4a" stroke="#696969" stroke-width="2" />
                        
                        <!-- Left tower -->
                        <rect x="360" y="60" width="80" height="140" fill="#4a4a4a" stroke="#696969" stroke-width="2" />
                        <!-- Left tower battlements -->
                        <rect x="360" y="60" width="16" height="18" fill="#4a4a4a" />
                        <rect x="381" y="60" width="16" height="18" fill="#4a4a4a" />
                        <rect x="402" y="60" width="16" height="18" fill="#4a4a4a" />
                        <rect x="423" y="60" width="17" height="18" fill="#4a4a4a" />
                        
                        <!-- Right tower -->
                        <rect x="640" y="70" width="70" height="130" fill="#4a4a4a" stroke="#696969" stroke-width="2" />
                        <!-- Right tower battlements -->
                        <rect x="640" y="70" width="14" height="16" fill="#4a4a4a" />
                        <rect x="659" y="70" width="14" height="16" fill="#4a4a4a" />
                        <rect x="678" y="70" width="14" height="16" fill="#4a4a4a" />
                        <rect x="697" y="70" width="13" height="16" fill="#4a4a4a" />
                        
                        <!-- Center tower (tallest) -->
                        <rect x="570" y="40" width="60" height="160" fill="#4a4a4a" stroke="#696969" stroke-width="2" />
                        <!-- Center tower battlements -->
                        <rect x="570" y="40" width="12" height="14" fill="#4a4a4a" />
                        <rect x="586" y="40" width="12" height="14" fill="#4a4a4a" />
                        <rect x="602" y="40" width="12" height="14" fill="#4a4a4a" />
                        <rect x="618" y="40" width="12" height="14" fill="#4a4a4a" />
                        
                        <!-- Castle roofs (pointed Gothic style) -->
                        <polygon points="360,60 400,30 440,60" fill="#5a5a5a" stroke="#4a4a4a" stroke-width="2" />
                        <polygon points="570,40 600,10 630,40" fill="#5a5a5a" stroke="#4a4a4a" stroke-width="2" />
                        <polygon points="640,70 675,40 710,70" fill="#5a5a5a" stroke="#4a4a4a" stroke-width="2" />
                        
                        <!-- Main battlements on base -->
                        <rect x="400" y="100" width="20" height="14" fill="#4a4a4a" />
                        <rect x="430" y="100" width="20" height="14" fill="#4a4a4a" />
                        <rect x="460" y="100" width="20" height="14" fill="#4a4a4a" />
                        <rect x="490" y="100" width="20" height="14" fill="#4a4a4a" />
                        <rect x="550" y="100" width="20" height="14" fill="#4a4a4a" />
                        <rect x="620" y="100" width="20" height="14" fill="#4a4a4a" />
                        
                        <!-- Gothic arched main gate -->
                        <path d="M 540 140 Q 540 130 550 130 L 570 130 Q 580 130 580 140 L 580 200 L 540 200 Z" fill="#000" stroke="#1a1a1a" stroke-width="1" />
                        <!-- Gate details -->
                        <rect x="565" y="160" width="10" height="40" fill="#2F2F2F" />
                        <circle cx="570" cy="170" r="2" fill="#4a4a4a" />
                        
                        <!-- Gothic arched windows (dim light) -->
                        <!-- Left tower windows -->
                        <path d="M 385 110 Q 385 100 395 100 Q 405 100 405 110 L 405 125 L 385 125 Z" fill="#ffb347" opacity="0.3" />
                        <path d="M 385 150 Q 385 140 395 140 Q 405 140 405 150 L 405 165 L 385 165 Z" fill="#ffb347" opacity="0.25" />
                        
                        <!-- Center tower windows -->
                        <path d="M 585 80 Q 585 70 595 70 Q 605 70 605 80 L 605 95 L 585 95 Z" fill="#ffb347" opacity="0.35" />
                        <path d="M 585 120 Q 585 110 595 110 Q 605 110 605 120 L 605 135 L 585 135 Z" fill="#ffb347" opacity="0.3" />
                        
                        <!-- Right tower windows -->
                        <path d="M 660 110 Q 660 100 670 100 Q 680 100 680 110 L 680 125 L 660 125 Z" fill="#ffb347" opacity="0.28" />
                        <path d="M 660 150 Q 660 140 670 140 Q 680 140 680 150 L 680 165 L 660 165 Z" fill="#ffb347" opacity="0.32" />
                        
                        <!-- Gothic spires and crosses -->
                        <!-- Left spire cross -->
                        <rect x="398" y="25" width="4" height="15" fill="#5a5a5a" />
                        <rect x="392" y="29" width="16" height="4" fill="#5a5a5a" />
                        
                        <!-- Center spire cross -->
                        <rect x="598" y="5" width="4" height="15" fill="#5a5a5a" />
                        <rect x="592" y="9" width="16" height="4" fill="#5a5a5a" />
                        
                        <!-- Right spire cross -->
                        <rect x="673" y="35" width="4" height="15" fill="#5a5a5a" />
                        <rect x="667" y="39" width="16" height="4" fill="#5a5a5a" />
                        
                        <!-- Gothic flags -->
                        <rect x="396" y="20" width="2" height="25" fill="#2F2F2F" />
                        <polygon points="398,20 398,32 410,26" fill="#4a4a4a" />
                        <rect x="596" y="0" width="2" height="30" fill="#2F2F2F" />
                        <polygon points="598,0 598,15 610,7.5" fill="#4a4a4a" />
                        <rect x="671" y="30" width="2" height="20" fill="#2F2F2F" />
                        <polygon points="673,30 673,42 685,36" fill="#4a4a4a" />
                        
                        <!-- Tree 3 -->
                        <rect x="800" y="110" width="22" height="90" fill="#2F2F2F" />
                        <ellipse cx="811" cy="100" rx="45" ry="38" fill="#1a472a" />
                        <ellipse cx="811" cy="80" rx="38" ry="32" fill="#1e5d32" />
                        <ellipse cx="811" cy="68" rx="28" ry="28" fill="#228b3d" />
                        
                        <!-- Tree 4 -->
                        <rect x="950" y="125" width="18" height="75" fill="#2F2F2F" />
                        <ellipse cx="959" cy="115" rx="35" ry="32" fill="#1a472a" />
                        <ellipse cx="959" cy="100" rx="30" ry="28" fill="#1e5d32" />
                        <ellipse cx="959" cy="90" rx="22" ry="22" fill="#228b3d" />
                        
                        <!-- Ground -->
                        <rect x="0" y="180" width="1000" height="20" fill="#1a4a2e" />
                    </svg>
                    <div class="bat-container" id="batContainer"></div>
                </div>
            </div>
            <div class="flashlight-indicator" id="flashlightIndicator"></div>
        </div>
        
        <!-- Result Screen -->
        <div class="result-screen hidden" id="resultScreen">
            <div class="result-box">
                <div class="zoom-in" id="resultBat"></div>
                <div class="result-text" id="resultText"></div>
                <div class="moon-phase-text" id="moonPhaseText"></div>
                <button class="button result-button" onclick="resetGame()">🌙 Hunt Again?</button>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            started: false,
            batFound: false,
            mousePos: { x: 0, y: 0 },
            batPosition: { x: 0, y: 0 },
            currentPose: 0,
            moonPhase: 0
        };

        // Initialize background elements
        function initBackground() {
            const background = document.getElementById('nightBackground');
            
            // Add stars
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 70 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (2 + Math.random() * 2) + 's';
                background.appendChild(star);
            }
            
            // Add big twinkling stars
            for (let i = 0; i < 15; i++) {
                const bigStar = document.createElement('div');
                bigStar.className = 'big-star';
                bigStar.style.left = Math.random() * 100 + '%';
                bigStar.style.top = Math.random() * 60 + '%';
                bigStar.style.animationDelay = Math.random() * 4 + 's';
                bigStar.style.animationDuration = (3 + Math.random() * 2) + 's';
                background.appendChild(bigStar);
            }
            
            // Add fireflies
            for (let i = 0; i < 8; i++) {
                const firefly = document.createElement('div');
                firefly.className = 'firefly';
                firefly.style.left = (20 + Math.random() * 60) + '%';
                firefly.style.top = (60 + Math.random() * 30) + '%';
                firefly.style.animationDelay = Math.random() * 2 + 's';
                firefly.style.animationDuration = (2 + Math.random() * 3) + 's';
                background.appendChild(firefly);
            }
            
            // Add some fireflies around the castle for extra atmosphere
            for (let i = 0; i < 3; i++) {
                const castleFirefly = document.createElement('div');
                castleFirefly.className = 'firefly';
                castleFirefly.style.left = (38 + Math.random() * 15) + '%';
                castleFirefly.style.top = (65 + Math.random() * 15) + '%';
                castleFirefly.style.animationDelay = Math.random() * 3 + 's';
                castleFirefly.style.animationDuration = (2.5 + Math.random() * 2) + 's';
                background.appendChild(castleFirefly);
            }
        }

        // Moon phases
        function createMoonPhase(phase) {
            const moonPhases = [
                // New Moon
                '<circle cx="50" cy="50" r="20" fill="#1a1a2e" stroke="#4a4a6a" stroke-width="2" />',
                // Waxing Crescent
                '<circle cx="50" cy="50" r="20" fill="#1a1a2e" stroke="#4a4a6a" stroke-width="2" /><path d="M 50 30 A 20 20 0 0 1 50 70 A 15 15 0 0 0 50 30" fill="#f5f5dc" />',
                // First Quarter
                '<circle cx="50" cy="50" r="20" fill="#1a1a2e" stroke="#4a4a6a" stroke-width="2" /><path d="M 50 30 A 20 20 0 0 1 50 70 Z" fill="#f5f5dc" />',
                // Waxing Gibbous
                '<circle cx="50" cy="50" r="20" fill="#1a1a2e" stroke="#4a4a6a" stroke-width="2" /><path d="M 50 30 A 20 20 0 0 1 50 70 A 8 8 0 0 1 50 30" fill="#f5f5dc" />',
                // Full Moon
                '<circle cx="50" cy="50" r="20" fill="#f5f5dc" stroke="#e6e68a" stroke-width="2" />',
                // Waning Gibbous
                '<circle cx="50" cy="50" r="20" fill="#f5f5dc" stroke="#e6e68a" stroke-width="2" /><path d="M 50 30 A 8 8 0 0 1 50 70 A 20 20 0 0 0 50 30" fill="#1a1a2e" />',
                // Last Quarter
                '<circle cx="50" cy="50" r="20" fill="#f5f5dc" stroke="#e6e68a" stroke-width="2" /><path d="M 50 30 A 20 20 0 0 0 50 70 Z" fill="#1a1a2e" />',
                // Waning Crescent
                '<circle cx="50" cy="50" r="20" fill="#f5f5dc" stroke="#e6e68a" stroke-width="2" /><path d="M 50 30 A 15 15 0 0 1 50 70 A 20 20 0 0 0 50 30" fill="#1a1a2e" />'
            ];
            
            let moonSvg = `<svg width="480" height="480" viewBox="0 0 100 100">${moonPhases[phase]}`;
            
            // Add craters for full phases
            if (phase === 4 || phase === 5 || phase === 6) {
                moonSvg += '<circle cx="45" cy="45" r="3" fill="#e6e68a" opacity="0.7" />';
                moonSvg += '<circle cx="58" cy="52" r="2" fill="#e6e68a" opacity="0.7" />';
                moonSvg += '<circle cx="52" cy="60" r="2.5" fill="#e6e68a" opacity="0.7" />';
            }
            
            moonSvg += '</svg>';
            return moonSvg;
        }

        // Bat SVGs
        function createBatSVG(isRevealed, pose) {
            const size = isRevealed ? 200 : 80;
            const poses = [
                // Sleeping Bat (pose 0)
                `<svg width="${size}" height="${size}" viewBox="0 0 100 100">
                    <rect x="20" y="15" width="60" height="6" fill="#4a3728" rx="3" />
                    <ellipse cx="35" cy="15" rx="3" ry="2" fill="#5d4537" />
                    <ellipse cx="65" cy="15" rx="3" ry="2" fill="#5d4537" />
                    <ellipse cx="35" cy="18" rx="2" ry="4" fill="#333" />
                    <ellipse cx="65" cy="18" rx="2" ry="4" fill="#333" />
                    <ellipse cx="50" cy="55" rx="18" ry="25" fill="#4a4a4a" stroke="#333" stroke-width="2" />
                    <circle cx="50" cy="75" r="12" fill="#666" stroke="#333" stroke-width="2" />
                    <ellipse cx="44" cy="68" rx="4" ry="8" fill="#555" stroke="#333" stroke-width="1" />
                    <ellipse cx="56" cy="68" rx="4" ry="8" fill="#555" stroke="#333" stroke-width="1" />
                    ${!isRevealed ? 
                        '<path d="M 45 74 C 47 74 47 74 47 74" stroke="#000" stroke-width="2" stroke-linecap="round"/><path d="M 53 74 C 55 74 55 74 55 74" stroke="#000" stroke-width="2" stroke-linecap="round"/>' :
                        '<rect x="40" y="72" width="20" height="4" rx="2" fill="#000" /><rect x="42" y="73" width="6" height="2" rx="1" fill="#333" /><rect x="52" y="73" width="6" height="2" rx="1" fill="#333" /><text x="62" y="65" font-size="8" fill="#87ceeb">Z</text><text x="68" y="60" font-size="6" fill="#87ceeb">z</text><text x="72" y="56" font-size="4" fill="#87ceeb">z</text>'
                    }
                    <ellipse cx="50" cy="77" rx="2" ry="1" fill="#000" />
                </svg>`,
                
                // Flying Bat (pose 1)
                `<svg width="${size}" height="${size}" viewBox="0 0 100 100">
                    <ellipse cx="25" cy="45" rx="15" ry="8" fill="#4a4a4a" stroke="#333" stroke-width="2" transform="rotate(-20 25 45)" />
                    <ellipse cx="75" cy="45" rx="15" ry="8" fill="#4a4a4a" stroke="#333" stroke-width="2" transform="rotate(20 75 45)" />
                    <ellipse cx="50" cy="50" rx="8" ry="15" fill="#666" stroke="#333" stroke-width="2" />
                    <circle cx="50" cy="35" r="10" fill="#666" stroke="#333" stroke-width="2" />
                    <ellipse cx="46" cy="28" rx="3" ry="6" fill="#555" stroke="#333" stroke-width="1" />
                    <ellipse cx="54" cy="28" rx="3" ry="6" fill="#555" stroke="#333" stroke-width="1" />
                    ${!isRevealed ? 
                        '<circle cx="46" cy="33" r="2" fill="#000" /><circle cx="54" cy="33" r="2" fill="#000" />' :
                        '<rect x="42" y="31" width="16" height="4" rx="2" fill="#000" /><rect x="44" y="32" width="5" height="2" rx="1" fill="#333" /><rect x="51" y="32" width="5" height="2" rx="1" fill="#333" /><path d="M 46 38 Q 50 40 54 38" stroke="#000" stroke-width="1.5" fill="none" stroke-linecap="round"/>'
                    }
                    <ellipse cx="50" cy="36" rx="1.5" ry="1" fill="#000" />
                </svg>`,
                
                // Alert Bat (pose 2)
                `<svg width="${size}" height="${size}" viewBox="0 0 100 100">
                    <rect x="25" y="80" width="50" height="6" fill="#4a3728" rx="3" />
                    <ellipse cx="40" cy="80" rx="2" ry="3" fill="#333" />
                    <ellipse cx="60" cy="80" rx="2" ry="3" fill="#333" />
                    <ellipse cx="35" cy="55" rx="10" ry="12" fill="#4a4a4a" stroke="#333" stroke-width="2" transform="rotate(-15 35 55)" />
                    <ellipse cx="65" cy="55" rx="10" ry="12" fill="#4a4a4a" stroke="#333" stroke-width="2" transform="rotate(15 65 55)" />
                    <ellipse cx="50" cy="60" rx="8" ry="18" fill="#666" stroke="#333" stroke-width="2" />
                    <circle cx="50" cy="35" r="12" fill="#666" stroke="#333" stroke-width="2" />
                    <ellipse cx="45" cy="25" rx="3" ry="8" fill="#555" stroke="#333" stroke-width="1" />
                    <ellipse cx="55" cy="25" rx="3" ry="8" fill="#555" stroke="#333" stroke-width="1" />
                    ${!isRevealed ? 
                        '<circle cx="46" cy="33" r="3" fill="#000" /><circle cx="54" cy="33" r="3" fill="#000" /><circle cx="46" cy="32" r="1" fill="#fff" /><circle cx="54" cy="32" r="1" fill="#fff" />' :
                        '<rect x="38" y="31" width="24" height="4" rx="2" fill="#000" /><rect x="40" y="32" width="8" height="2" rx="1" fill="#333" /><rect x="52" y="32" width="8" height="2" rx="1" fill="#333" />'
                    }
                    <ellipse cx="50" cy="37" rx="2" ry="1" fill="#000" />
                </svg>`,
                
                // Vampire Bat (pose 3)
                `<svg width="${size}" height="${size}" viewBox="0 0 100 100">
                    <path d="M 20 50 Q 15 40 25 45 Q 35 35 45 50" fill="#1a1a1a" stroke="#000" stroke-width="2" />
                    <path d="M 55 50 Q 65 35 75 45 Q 85 40 80 50" fill="#1a1a1a" stroke="#000" stroke-width="2" />
                    <ellipse cx="50" cy="55" rx="10" ry="18" fill="#333" stroke="#000" stroke-width="2" />
                    <path d="M 42 42 Q 50 38 58 42 Q 55 48 50 46 Q 45 48 42 42" fill="#8b0000" stroke="#000" stroke-width="1" />
                    <circle cx="50" cy="35" r="12" fill="#666" stroke="#000" stroke-width="2" />
                    <path d="M 43 28 L 40 20 L 46 26 Z" fill="#555" stroke="#000" stroke-width="1" />
                    <path d="M 57 28 L 54 26 L 60 20 Z" fill="#555" stroke="#000" stroke-width="1" />
                    ${!isRevealed ? 
                        '<circle cx="46" cy="32" r="2.5" fill="#ff0000" /><circle cx="54" cy="32" r="2.5" fill="#ff0000" />' :
                        '<rect x="38" y="30" width="24" height="4" rx="2" fill="#000" /><rect x="40" y="31" width="8" height="2" rx="1" fill="#333" /><rect x="52" y="31" width="8" height="2" rx="1" fill="#333" /><path d="M 45 39 Q 50 42 55 39" stroke="#8b0000" stroke-width="2" fill="none" stroke-linecap="round"/>'
                    }
                    <ellipse cx="50" cy="36" rx="2" ry="1" fill="#000" />
                    <path d="M 47 37 L 47 41 L 48 37 Z" fill="#fff" />
                    <path d="M 52 37 L 52 41 L 53 37 Z" fill="#fff" />
                </svg>`
            ];
            
            return poses[pose];
        }

        // Sound effects
        async function playSound(type) {
            await Tone.start();
            
            if (type === 'start') {
                const synth = new Tone.Synth({
                    oscillator: { type: "triangle" },
                    envelope: { attack: 0.3, decay: 0.5, sustain: 0.3, release: 0.8 }
                }).toDestination();
                synth.triggerAttackRelease("G4", "2n");
                setTimeout(() => synth.triggerAttackRelease("B4", "2n"), 300);
                setTimeout(() => synth.triggerAttackRelease("D5", "1n"), 600);
                setTimeout(() => synth.dispose(), 2000);
            } else if (type === 'click') {
                const synth = new Tone.Synth({
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 }
                }).toDestination();
                synth.triggerAttackRelease("C5", "32n");
                setTimeout(() => synth.dispose(), 200);
            } else if (type === 'found') {
                const synth = new Tone.PolySynth().toDestination();
                synth.triggerAttackRelease(["E4", "G#4", "B4", "E5"], "4n");
                
                setTimeout(() => {
                    const sparkleSynth = new Tone.Synth({
                        oscillator: { type: "sine" },
                        envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 }
                    }).toDestination();
                    sparkleSynth.volume.value = -10;
                    sparkleSynth.triggerAttackRelease("G5", "16n");
                    setTimeout(() => sparkleSynth.triggerAttackRelease("B5", "16n"), 100);
                    setTimeout(() => sparkleSynth.triggerAttackRelease("D6", "16n"), 200);
                    setTimeout(() => sparkleSynth.dispose(), 500);
                }, 100);
                
                setTimeout(() => synth.dispose(), 1000);
            }
        }

        // Game functions
        function startGame() {
            gameState.batPosition.x = Math.random() * 70 + 15;
            gameState.batPosition.y = Math.random() * 60 + 20;
            gameState.currentPose = Math.floor(Math.random() * 4);
            gameState.moonPhase = Math.floor(Math.random() * 8);
            gameState.started = true;
            gameState.batFound = false;
            
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            // Update moon for game - use the existing moon element or create if needed
            let gameMoon = document.getElementById('moon');
            if (!gameMoon) {
                gameMoon = document.getElementById('initialMoon');
                if (gameMoon) {
                    gameMoon.id = 'moon';
                }
            }
            if (gameMoon) {
                gameMoon.innerHTML = createMoonPhase(gameState.moonPhase);
            }
            
            // Set up bat
            const batContainer = document.getElementById('batContainer');
            batContainer.innerHTML = createBatSVG(false, gameState.currentPose);
            batContainer.style.left = gameState.batPosition.x + '%';
            batContainer.style.top = gameState.batPosition.y + '%';
            
            playSound('start');
        }

        function resetGame() {
            gameState.started = false;
            gameState.batFound = false;
            
            document.getElementById('resultScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            
            // Generate new moon phase for start screen
            const newMoonPhase = Math.floor(Math.random() * 8);
            const moonElement = document.getElementById('moon') || document.getElementById('initialMoon');
            if (moonElement) {
                moonElement.innerHTML = createMoonPhase(newMoonPhase);
                if (moonElement.id === 'moon') {
                    moonElement.id = 'initialMoon';
                }
            }
        }

        function getMoonPhaseName(phase) {
            const names = ["New Moon", "Waxing Crescent", "First Quarter", "Waxing Gibbous", 
                           "Full Moon", "Waning Gibbous", "Last Quarter", "Waning Crescent"];
            return names[phase];
        }

        function checkBatClick(event) {
            if (!gameState.batFound) {
                const rect = document.getElementById('gameContainer').getBoundingClientRect();
                const clickX = ((event.clientX - rect.left) / rect.width) * 100;
                const clickY = ((event.clientY - rect.top) / rect.height) * 100;
                
                const distance = Math.sqrt(
                    Math.pow(clickX - gameState.batPosition.x, 2) + 
                    Math.pow(clickY - gameState.batPosition.y, 2)
                );
                
                const mouseX = event.clientX - rect.left;
                const mouseY = event.clientY - rect.top;
                const flashlightDistance = Math.sqrt(
                    Math.pow(mouseX - gameState.mousePos.x, 2) + 
                    Math.pow(mouseY - gameState.mousePos.y, 2)
                );
                
                if (flashlightDistance < 60 && distance < 12) {
                    gameState.batFound = true;
                    
                    // Show result screen
                    document.getElementById('gameScreen').classList.add('hidden');
                    document.getElementById('resultScreen').classList.remove('hidden');
                    
                    // Set up result
                    const resultTexts = [
                        "💤 SLEEPY BAT! 💤",
                        "🦇 FLYING HIGH! 🦇", 
                        "👁️ WIDE AWAKE! 👁️",
                        "🧛 SPOOKY BAT! 🧛"
                    ];
                    
                    document.getElementById('resultBat').innerHTML = createBatSVG(true, gameState.currentPose);
                    document.getElementById('resultText').textContent = resultTexts[gameState.currentPose];
                    document.getElementById('moonPhaseText').textContent = `Found under the ${getMoonPhaseName(gameState.moonPhase)}!`;
                    
                    playSound('found');
                } else {
                    playSound('click');
                }
            }
        }

        // Mouse tracking
        document.addEventListener('mousemove', (event) => {
            if (gameState.started && !gameState.batFound) {
                const rect = document.getElementById('gameContainer').getBoundingClientRect();
                gameState.mousePos.x = event.clientX - rect.left;
                gameState.mousePos.y = event.clientY - rect.top;
                
                const illuminatedScene = document.getElementById('illuminatedScene');
                const flashlightIndicator = document.getElementById('flashlightIndicator');
                
                // Update mask position
                illuminatedScene.style.webkitMaskImage = `radial-gradient(circle 60px at ${gameState.mousePos.x}px ${gameState.mousePos.y}px, white 0%, white 100%, transparent 100%)`;
                illuminatedScene.style.maskImage = `radial-gradient(circle 60px at ${gameState.mousePos.x}px ${gameState.mousePos.y}px, white 0%, white 100%, transparent 100%)`;
                
                // Update flashlight indicator position
                flashlightIndicator.style.left = (gameState.mousePos.x - 64) + 'px';
                flashlightIndicator.style.top = (gameState.mousePos.y - 64) + 'px';
            }
        });

        // Click handler
        document.getElementById('gameScreen').addEventListener('click', checkBatClick);

        // Initialize the game
        function init() {
            initBackground();
            // Always show initial moon on start screen
            const initialMoon = document.createElement('div');
            initialMoon.className = 'moon';
            initialMoon.id = 'initialMoon';
            initialMoon.style.zIndex = '2';
            initialMoon.innerHTML = createMoonPhase(Math.floor(Math.random() * 8));
            document.getElementById('gameContainer').appendChild(initialMoon);
        }
        
        init();
    </script>
</body>
</html>